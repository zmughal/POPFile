# ---------------------------------------------------------------------------
#
# Test script for the HTML interface, loaded by TestHTML.tst
#
# Copyright (c) 2001-2011 John Graham-Cumming
#
#   This file is part of POPFile
#
#   POPFile is free software; you can redistribute it and/or modify it
#   under the terms of version 2 of the GNU General Public License as
#   published by the Free Software Foundation.
#
#   POPFile is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with POPFile; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
#
# ---------------------------------------------------------------------------

# To simplify testing the POPFile HTML UI this file contains a script
# that is read by TestHTML.tst and executed.  The script consists of instructions
# for specific URLs that are to be hit and instructions for how to match the
# result that comes back
#
# The commands are as follows
#
# GET <url>         Get the URL (note the host and port will be added for you)
# MATCH <data>      Match the return from last URL fetch against the data
# NOTMATCH <data>   Must not match the return from last URL fetch against the data
# MATCH/ENDMATCH    Encloses a block of test to find in the return from the last URL fetch
# CODE/ENDCODE      Arbitrary code that should be executed
# INPUTIS a b       Assert that form item a has value b
# SETINPUT a b      Sets the form item a to value b
# SETINPUTN a b c   Sets the bth input named a to c
# SUBMIT a          Finds the form with input a and submits it
# SETSUBMIT a b     Just like doing SETINPUT a b followed by SUBMIT a
# CONFIGIS a b      Verify that config item a has value b
# SETCONFIG u a b     Set config item a for user u to b
# USERCONFIGIS u a b  Verify that config item a for user u has value b
# SETUSERCONFIG u a b Set config item a for user u to b
# MAGNETIS a b c    Checks that magnet c exists in bucket a with type b
# PARAMETERIS a b c Check that parameter b in bucket a has value c
# CLICK a           Click the button called a
# SENDMSG a b       Send a message through the POPFile MQ (message a with parameter b)
# STOP              Terminate the script, used for debugging
# HIDDEN a          If a is 1 then allow matching on hidden form elements
# ISVALIDPASSWORD a Check that password a is valid for the current user
#                   (by default this is 0)
#
# Expect that the following are available to you within the MATCH/ENDMATCH block
#
# $port             The port on which the HTML interface is running
# $url              URL object for the last URL specified
# $content          String containing the return from the last URL fetch

# Test the simplest functionality of the HTML interface

# Look for elements that should appear at the TOP and BOTTOM
# of every page

GET /

# Common TOP parts

MATCH <title>POPFile Control Center</title>
MATCH <html lang="en">
MATCH <link rel="stylesheet" type="text/css" href="skins/default/style.css" media="all" title="POPFile">
MATCH <link rel="icon" href="favicon.ico">

MATCH <a class="shutdownLink" href="/shutdown">Shutdown POPFile</a>

# Common MIDDLE parts (i.e. the tabs)

MATCH <a class="menuLink" href="/history"
MATCH History</a>
MATCH <a class="menuLink" href="/buckets"
MATCH Buckets</a>
MATCH <a class="menuLink" href="/magnets"
MATCH Magnets</a>
MATCH <a class="menuLink" href="/administration"
MATCH Administration</a>
MATCH <a class="menuLink" href="/advanced"
MATCH Advanced</a>

NOTMATCH <a class="menuLink" href="/users"
NOTMATCH Users</a>

# Common BOTTOM parts

MATCH
<a class="bottomLink" href="http://getpopfile.org/" title="Visit the POPFile home page">
POPFile Home Page</a>
ENDMATCH
MATCH
<a class="bottomLink" href="http://getpopfile.org/docs/FAQ" title="POPFile Frequently Asked Questions">
FAQ</a>
ENDMATCH
MATCH
<a class="bottomLink" href="http://getpopfile.org/docs/index.php" title="POPFile's documentation wiki">
Documentation</a>
ENDMATCH

# Verify that each of the pages highlights the correct item on
# the tab bar and hence the simplest level of page serving is working
# correctly

GET /history
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/history"
ENDMATCH

GET /buckets
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/buckets"
ENDMATCH

GET /magnets
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/magnets"
ENDMATCH

GET /administration
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/administration"
ENDMATCH

GET /advanced
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/advanced"
ENDMATCH

GET /users
MATCH POPFile Web Server Error 404

# Enter the Multi user mode

GET /administration
INPUTIS   usermode on
CONFIGIS  GLOBAL_single_user 1
SETINPUT  usermode off
CLICK     apply_stealth
INPUTIS   usermode
CONFIGIS  GLOBAL_single_user 0
MATCH     POPFile is now in the Multiuser Mode. You are recommended to restart POPFile.
MATCH     <a class="logoutLink" href="/logout">Logout (admin)</a>

# Login page

GET       /logout
MATCH     <h2 class="password">Login</h2>
MATCH     User name
MATCH     Password
SETINPUT  username admin
SETSUBMIT password wrongpassword
MATCH     Incorrect user name or password
SETINPUT  username wronguser
SETSUBMIT password
MATCH     Incorrect user name or password

SETINPUT  username admin
SETSUBMIT password
MATCH     Recent Messages

# Does not redirect to login page

GET       /logout
GET       /administration
MATCH     <input type="hidden" id="next" name="next" value="%2Fadministration" />
GET       /logout
MATCH     <input type="hidden" id="next" name="next" value="%2F" />
SETINPUT  username admin
SETSUBMIT password

# Administration page (Current Active User sessions)

GET       /administration
MATCH     Current Active User Sessions
MATCH     <td aligh="left" >admin</td>

# Advanced page (No single user mode options)

GET       /advanced
NOTMATCH  Single User Mode Parameters

# Users page

# Create user

GET       /users
MATCH     Create New User
SETSUBMIT newuser testuser
MATCH     Created user &#39;testuser&#39; (initial password &#39;
SETSUBMIT newuser testuser
MATCH     User &#39;testuser&#39; not created: already exists
SETSUBMIT newuser testuser2
MATCH     Created user &#39;testuser2&#39; (initial password &#39;

SETINPUT  newuser admin_clone
SETSUBMIT clone admin
MATCH     Created user &#39;admin_clone&#39; as clone of &#39;admin&#39; (initial password &#39;

SETINPUT  newuser admin_clone_with_data
SETINPUT  clone admin
SETINPUT  users_copy_magnets on
SETSUBMIT users_copy_corpus on
MATCH     Created user &#39;admin_clone_with_data&#39; as clone of &#39;admin&#39; (initial password &#39;

# Remove User

GET       /users
MATCH     Remove Existing User
MATCH
<select name="toremove">
<option value="">&nbsp;</option>
<option>admin_clone</option>
<option>testuser2</option>
<option>testuser</option>
<option>admin_clone_with_data</option>
</select>
ENDMATCH
SETSUBMIT toremove testuser
MATCH     Removed user &#39;testuser&#39;
MATCH
<select name="toremove">
<option value="">&nbsp;</option>
<option>admin_clone</option>
<option>testuser2</option>
<option>admin_clone_with_data</option>
</select>
ENDMATCH
SETSUBMIT toremove admin_clone
MATCH     Failed to remove user &#39;admin_clone&#39;: disable admin rights first
MATCH
<select name="toremove">
<option value="">&nbsp;</option>
<option>admin_clone</option>
<option>testuser2</option>
<option>admin_clone_with_data</option>
</select>
ENDMATCH

# Rename user

GET       /users
MATCH     Rename Existing User
MATCH
<select name="torename">
<option value="">&nbsp;</option>
<option>admin_clone</option>
<option>testuser2</option>
<option>admin_clone_with_data</option>
</select>
ENDMATCH
SETINPUT  torename testuser2
SETSUBMIT newname renameduser
MATCH     Renamed user &#39;testuser2&#39; to &#39;renameduser&#39; (initial password &#39;
MATCH
<select name="torename">
<option value="">&nbsp;</option>
<option>admin_clone</option>
<option>renameduser</option>
<option>admin_clone_with_data</option>
</select>
ENDMATCH
SETINPUT  torename renameduser
SETSUBMIT newname admin
MATCH     Failed to rename user &#39;renameduser&#39; to &#39;admin&#39;: already exists

# Initialize user's password

GET       /users
MATCH     Change/Initialize User's Password
MATCH
<select name="tochangepassword">
<option value="">&nbsp;</option>
<option>admin_clone</option>
<option>admin</option>
<option>renameduser</option>
<option>admin_clone_with_data</option>
</select>
ENDMATCH
SETINPUT  tochangepassword renameduser
SETSUBMIT users_reset_password on
MATCH     Initialized password for user &#39;renameduser&#39; (new initial password &#39;

# Set user's password

GET       /users
SETINPUT  tochangepassword renameduser
SETINPUT  users_new_password newpassword
SETSUBMIT users_confirm_password newpassword
MATCH     Changed password for user &#39;renameduser&#39;
SETINPUT  tochangepassword renameduser
SETINPUT  users_new_password newpassword2
SETSUBMIT users_confirm_password wrongconfirmpassword
MATCH     Failed to change password for user &#39;renameduser&#39;: The new password must by identical in the New and Confirm New boxes

SETINPUT  tochangepassword admin_clone
SETINPUT  users_new_password newpassword
SETSUBMIT users_confirm_password newpassword
MATCH     Changed password for user &#39;admin_clone&#39;

SETINPUT  tochangepassword admin_clone_with_data
SETINPUT  users_new_password newpassword
SETSUBMIT users_confirm_password newpassword
MATCH     Changed password for user &#39;admin_clone_with_data&#39;

# Edit user's settings

GET       /users
MATCH     Edit User Settings
MATCH
<select name="editname">
<option value="">&nbsp;</option>
<option>admin_clone</option>
<option>admin</option>
<option>renameduser</option>
<option>admin_clone_with_data</option>
</select>
ENDMATCH
SETSUBMIT editname admin
MATCH     Associated POP3 Accounts (admin)
MATCH     Parameters (admin)

# Add account

SETSUBMIT newaccount foo:bar
MATCH
<tr>
<th class="usersLabel" scope="col" align="left">
POP3 Account
</th>
<th class="usersLabel" scope="col">
Remove
</th>
</tr>
ENDMATCH
MATCH
<td>
foo:bar
</td>
ENDMATCH

SETINPUT  newaccount fooz:bar
CLICK     addaccount
MATCH
<td>
fooz:bar
</td>
ENDMATCH

SETINPUT  newaccount foo:bar
CLICK     addaccount
MATCH     Failed to add the account because it is assigned to another user

SETINPUT  newaccount badaccount
CLICK     addaccount
MATCH     The new account name must be in the form host:user

# Remove account

SETINPUT  remove_fooz:bar on
CLICK     delete
NOTMATCH  fooz:bar

# Edit parameters

INPUTIS   parameter_history_history_days 2
USERCONFIGIS admin history_history_days 2
SETSUBMIT parameter_history_history_days 10
INPUTIS   parameter_history_history_days 10
USERCONFIGIS admin history_history_days 10
SETSUBMIT parameter_history_history_days 2

INPUTIS   parameter_GLOBAL_can_admin 1
USERCONFIGIS admin GLOBAL_can_admin 1
SETSUBMIT parameter_GLOBAL_can_admin 0
INPUTIS   parameter_GLOBAL_can_admin 1
USERCONFIGIS admin GLOBAL_can_admin 1

# Timeout test

GET       /advanced
CONFIGIS  GLOBAL_session_timeout 1800
INPUTIS   parameter_GLOBAL_session_timeout 1800
SETSUBMIT parameter_GLOBAL_session_timeout 1
CONFIGIS  GLOBAL_session_timeout 1
INPUTIS   parameter_GLOBAL_session_timeout 1

CODE
select( undef, undef, undef, 5 ); # wait for timeout
ENDCODE

GET       /advanced
MATCH     Login
MATCH     POPFile session has been expired because a timeout period passed
SETINPUT  username admin
SETSUBMIT password

GET       /advanced
SETSUBMIT parameter_GLOBAL_session_timeout 1800
CONFIGIS  GLOBAL_session_timeout 1800
INPUTIS   parameter_GLOBAL_session_timeout 1800

GET       /logout

# Login as standard (non-admin) user

GET       /
SETINPUT  username renameduser
SETSUBMIT password wrongpassword
MATCH     Incorrect user name or password
SETINPUT  username renameduser
SETSUBMIT password newpassword

MATCH <a class="menuLink" href="/history"
MATCH History</a>
MATCH <a class="menuLink" href="/buckets"
MATCH Buckets</a>
MATCH <a class="menuLink" href="/magnets"
MATCH Magnets</a>

NOTMATCH <a class="menuLink" href="/administration"
NOTMATCH Administration</a>
NOTMATCH <a class="menuLink" href="/users"
NOTMATCH Users</a>
NOTMATCH <a class="menuLink" href="/advanced"
NOTMATCH Advanced</a>

MATCH     <a class="logoutLink" href="/logout">Logout (renameduser)</a>
NOTMATCH  <a class="shutdownLink" href="/shutdown">Shutdown POPFile</a>

# Standard user can't access the log file

GET /popfile_current_log.log
MATCH POPFile Web Server Error 404

# No History

GET /history
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/history"
ENDMATCH
MATCH     No messages.

# No Buckets

GET /buckets
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/buckets"
ENDMATCH
MATCH
<span style="color:black">
unclassified
</span>
ENDMATCH
MATCH
<td align="right">
0 (  0.00%)
</td>
<td align="right">
0
</td>
<td align="right">
</td>
ENDMATCH

# No Magnets

GET /magnets
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/magnets"
ENDMATCH
NOTMATCH  text1

# Non admin users can't access these pages

GET   /administration
MATCH POPFile Web Server Error 404
GET   /users
MATCH POPFile Web Server Error 404
GET   /advanced
MATCH POPFile Web Server Error 404

GET   /shutdown
MATCH POPFile Web Server Error 404

# Language test

GET          /
MATCH        <html lang="en">
USERCONFIGIS renameduser html_language English
SETSUBMIT    language Francais
MATCH        <html lang="fr">
USERCONFIGIS renameduser html_language Francais
USERCONFIGIS admin html_language English
SETSUBMIT    language English
MATCH        <html lang="en">
USERCONFIGIS renameduser html_language English

GET /logout

# Login as cloned admin without data

GET /
SETINPUT  username admin_clone
SETSUBMIT password newpassword

MATCH <a class="menuLink" href="/history"
MATCH History</a>
MATCH <a class="menuLink" href="/buckets"
MATCH Buckets</a>
MATCH <a class="menuLink" href="/magnets"
MATCH Magnets</a>
MATCH <a class="menuLink" href="/administration"
MATCH Administration</a>
MATCH <a class="menuLink" href="/users"
MATCH Users</a>
MATCH <a class="menuLink" href="/advanced"
MATCH Advanced</a>

MATCH <a class="logoutLink" href="/logout">Logout (admin_clone)</a>
MATCH <a class="shutdownLink" href="/shutdown">Shutdown POPFile</a>

# No history

GET       /history
MATCH     No messages.

# Buckets

GET /buckets
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/buckets"
ENDMATCH
MATCH
<span style="color:red">
other
</span>
ENDMATCH
MATCH
<span style="color:green">
personal
</span>
ENDMATCH
MATCH
<span style="color:blue">
spam
</span>
ENDMATCH
MATCH
<span style="color:black">
unclassified
</span>
ENDMATCH
MATCH
<td align="right">
0
</td>
ENDMATCH
MATCH
<td align="right">
0 (0.00%)
</td>
<td align="right">
0
</td>
<td align="right">
0
</td>
ENDMATCH
MATCH
<td align="right">
0 (0.00%)
</td>
<td align="right">
0
</td>
<td align="right">
</td>
ENDMATCH

# No magnets

GET /magnets
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/magnets"
ENDMATCH
NOTMATCH  text1

GET /logout

# Login as cloned admin with data

GET /
SETINPUT  username admin_clone_with_data
SETSUBMIT password newpassword

MATCH <a class="menuLink" href="/history"
MATCH History</a>
MATCH <a class="menuLink" href="/buckets"
MATCH Buckets</a>
MATCH <a class="menuLink" href="/magnets"
MATCH Magnets</a>
MATCH <a class="menuLink" href="/administration"
MATCH Administration</a>
MATCH <a class="menuLink" href="/users"
MATCH Users</a>
MATCH <a class="menuLink" href="/advanced"
MATCH Advanced</a>

MATCH     <a class="logoutLink" href="/logout">Logout (admin_clone_with_data)</a>
MATCH <a class="shutdownLink" href="/shutdown">Shutdown POPFile</a>

# History is not copied

GET       /history
MATCH     No messages.

# Buckets

GET       /buckets
MATCH
<span style="color:red">
other
</span>
ENDMATCH
MATCH
<span style="color:green">
personal
</span>
ENDMATCH
MATCH
<span style="color:blue">
spam
</span>
ENDMATCH
MATCH
<span style="color:black">
unclassified
</span>
ENDMATCH

MATCH
<td align="right">
656
</td>
ENDMATCH
MATCH
<td align="right">
3
</td>
ENDMATCH
MATCH
<td align="right">
3,353
</td>
ENDMATCH

# Magnets

GET       /magnets
INPUTIS text1 oldstyle
INPUTIS bucket1 personal
INPUTIS type1 from
INPUTIS text2 bar
INPUTIS bucket2 personal
INPUTIS type2 subject
INPUTIS text3 baz\@baz.com
INPUTIS bucket3 personal
INPUTIS type3 to

GET /logout

# Return to the single user mode

GET       /administration
SETINPUT  username admin
SETSUBMIT password

INPUTIS   usermode
CONFIGIS  GLOBAL_single_user 0
SETINPUT  usermode on
CLICK     apply_stealth
INPUTIS   usermode on
CONFIGIS  GLOBAL_single_user 1
NOTMATCH  <a class="logoutLink" href="/logout">Logout (admin)</a>
MATCH     POPFile is now in the Single User Mode (POPFile classic). You are recommended to restart POPFile.

# Config Bar

GET /history

# Show/Hide Config Bar

MATCH    <a name="configBar" title="Hide configuration bar" href="/history?hide_configbar=1">Config Bar</a>
MATCH    <table class="configBarBody" cellspacing="0" width="100%" summary="">
GET      /history?hide_configbar=1
MATCH    <a title="Show configuration bar" href="/history?show_configbar=1#configBar">Config Bar</a>
NOTMATCH <table class="configBarBody" cellspacing="0" width="100%" summary="">
GET      /history?show_configbar=1
MATCH    <a name="configBar" title="Hide configuration bar" href="/history?hide_configbar=1">Config Bar</a>

# Check skin change

MATCH        <link rel="stylesheet" type="text/css" href="skins/default/style.css" media="all" title="POPFile">
USERCONFIGIS admin html_skin default
SETSUBMIT    skin oceanblue
MATCH        <link rel="stylesheet" type="text/css" href="skins/oceanblue/style.css" title="POPFile-Style">
USERCONFIGIS admin html_skin oceanblue
SETSUBMIT    skin default
USERCONFIGIS admin html_skin default

# Check language change

MATCH        <html lang="en">
USERCONFIGIS admin html_language English
SETSUBMIT    language Francais
MATCH        <html lang="fr">
USERCONFIGIS admin html_language Francais
SETSUBMIT    language English
MATCH        <html lang="en">
USERCONFIGIS admin html_language English

# Check history lines change

INPUTIS      page_size 20
USERCONFIGIS admin html_page_size 20
SETSUBMIT    page_size 30
INPUTIS      page_size 30
USERCONFIGIS admin html_page_size 30
#MATCH        Updated number of messages per page to 30
SETSUBMIT    page_size 0
MATCH        The page size must be a number between 1 and 1000
INPUTIS      page_size 30
SETSUBMIT    page_size 20
USERCONFIGIS admin html_page_size 20

# Check history days change

INPUTIS      history_days 2
USERCONFIGIS admin history_history_days 2
SETSUBMIT    history_days 3
INPUTIS      history_days 3
USERCONFIGIS admin history_history_days 3
#MATCH        Updated number of days of history to 3
SETSUBMIT    history_days 0
#MATCH        The number of days in the history must be a number between 1 and 366
INPUTIS      history_days 3

# Add/Remove columns

MATCH
<a href="/history?setsort=inserted" title="Sort by this column">
<em class="historyLabelSort">
&lt;&nbsp;Arrived
</em>
</a>
ENDMATCH
MATCH
<a href="/history?setsort=from" title="Sort by this column">
From
</a>
ENDMATCH
MATCH
<a href="/history?setsort=to" title="Sort by this column">
To
</a>
ENDMATCH
MATCH
<a href="/history?setsort=subject" title="Sort by this column">
Subject
</a>
ENDMATCH
MATCH
<a href="/history?setsort=bucket" title="Sort by this column">
Bucket
</a>
ENDMATCH
MATCH
<input type="hidden" id="inserted" name="inserted">
<input type="hidden" id="from" name="from">
<input type="hidden" id="to" name="to">
<span class="checkLabel"><input type="checkbox" id="cc" class="checkbox" name="cc">&nbsp;<label for="cc">Cc</label>&nbsp;</span>
<input type="hidden" id="subject" name="subject">
<span class="checkLabel"><input type="checkbox" id="date" class="checkbox" name="date">&nbsp;<label for="date">Date</label>&nbsp;</span>
<span class="checkLabel"><input type="checkbox" id="size" class="checkbox" name="size">&nbsp;<label for="size">Size</label>&nbsp;</span>
<input type="hidden" id="bucket" name="bucket">
ENDMATCH
USERCONFIGIS admin html_columns +inserted,+from,+to,-cc,+subject,-date,-size,+bucket,

SETINPUT date on
CLICK    update_fields
MATCH
<a href="/history?setsort=date" title="Sort by this column">
Date
</a>
ENDMATCH
MATCH
<input type="hidden" id="inserted" name="inserted">
<input type="hidden" id="from" name="from">
<input type="hidden" id="to" name="to">
<span class="checkLabel"><input type="checkbox" id="cc" class="checkbox" name="cc">&nbsp;<label for="cc">Cc</label>&nbsp;</span>
<input type="hidden" id="subject" name="subject">
<input type="hidden" id="date" name="date">
<span class="checkLabel"><input type="checkbox" id="size" class="checkbox" name="size">&nbsp;<label for="size">Size</label>&nbsp;</span>
<input type="hidden" id="bucket" name="bucket">
ENDMATCH
USERCONFIGIS admin html_columns +inserted,+from,+to,-cc,+subject,+date,-size,+bucket,

SETINPUT size on
CLICK    update_fields
MATCH
<a href="/history?setsort=size" title="Sort by this column">
Size
</a>
ENDMATCH
MATCH
<input type="hidden" id="inserted" name="inserted">
<input type="hidden" id="from" name="from">
<input type="hidden" id="to" name="to">
<span class="checkLabel"><input type="checkbox" id="cc" class="checkbox" name="cc">&nbsp;<label for="cc">Cc</label>&nbsp;</span>
<input type="hidden" id="subject" name="subject">
<input type="hidden" id="date" name="date">
<input type="hidden" id="size" name="size">
<input type="hidden" id="bucket" name="bucket">
ENDMATCH
USERCONFIGIS admin html_columns +inserted,+from,+to,-cc,+subject,+date,+size,+bucket,

MATCH    <a class="columnRemove" href="/history?removecolumn=date"><img title="Remove column" src="skins/x.gif" border="0" alt="x"></a>
MATCH    <a class="columnRemove" href="/history?removecolumn=size"><img title="Remove column" src="skins/x.gif" border="0" alt="x"></a>

GET      /history?removecolumn=date
NOTMATCH <a class="columnRemove" href="/history?removecolumn=date"><img title="Remove column" src="skins/x.gif" border="0" alt="x"></a>
MATCH    <a class="columnRemove" href="/history?removecolumn=size"><img title="Remove column" src="skins/x.gif" border="0" alt="x"></a>
MATCH
<input type="hidden" id="inserted" name="inserted">
<input type="hidden" id="from" name="from">
<input type="hidden" id="to" name="to">
<span class="checkLabel"><input type="checkbox" id="cc" class="checkbox" name="cc">&nbsp;<label for="cc">Cc</label>&nbsp;</span>
<input type="hidden" id="subject" name="subject">
<span class="checkLabel"><input type="checkbox" id="date" class="checkbox" name="date">&nbsp;<label for="date">Date</label>&nbsp;</span>
<input type="hidden" id="size" name="size">
<input type="hidden" id="bucket" name="bucket">
ENDMATCH
USERCONFIGIS admin html_columns +inserted,+from,+to,-cc,+subject,-date,+size,+bucket,

GET      /history?removecolumn=size
NOTMATCH <a class="columnRemove" href="/history?removecolumn=size"><img title="Remove column" src="skins/x.gif" border="0" alt="x"></a>
MATCH
<input type="hidden" id="inserted" name="inserted">
<input type="hidden" id="from" name="from">
<input type="hidden" id="to" name="to">
<span class="checkLabel"><input type="checkbox" id="cc" class="checkbox" name="cc">&nbsp;<label for="cc">Cc</label>&nbsp;</span>
<input type="hidden" id="subject" name="subject">
<span class="checkLabel"><input type="checkbox" id="date" class="checkbox" name="date">&nbsp;<label for="date">Date</label>&nbsp;</span>
<span class="checkLabel"><input type="checkbox" id="size" class="checkbox" name="size">&nbsp;<label for="size">Size</label>&nbsp;</span>
<input type="hidden" id="bucket" name="bucket">
ENDMATCH
USERCONFIGIS admin html_columns +inserted,+from,+to,-cc,+subject,-date,-size,+bucket,

# Move column left/right

MATCH    <a class="columnMove" href="/history?moveright=inserted"><img title="Move right" src="skins/rightarrow.gif" border="0" alt="&gt;"></a>
MATCH    <a class="columnMove" href="/history?moveleft=from"><img title="Move left" src="skins/leftarrow.gif" border="0" alt="&lt;"></a>
GET      /history?moveright=inserted
MATCH    <a class="columnMove" href="/history?moveleft=inserted"><img title="Move left" src="skins/leftarrow.gif" border="0" alt="&lt;"></a>
MATCH    <a class="columnMove" href="/history?moveright=inserted"><img title="Move right" src="skins/rightarrow.gif" border="0" alt="&gt;"></a>
NOTMATCH <a class="columnMove" href="/history?moveleft=from"><img title="Move left" src="skins/leftarrow.gif" border="0" alt="&lt;"></a>
USERCONFIGIS admin html_columns +from,+inserted,+to,-cc,+subject,-date,-size,+bucket

GET      /history?moveleft=inserted
MATCH    <a class="columnMove" href="/history?moveright=inserted"><img title="Move right" src="skins/rightarrow.gif" border="0" alt="&gt;"></a>
MATCH    <a class="columnMove" href="/history?moveleft=from"><img title="Move left" src="skins/leftarrow.gif" border="0" alt="&lt;"></a>
NOTMATCH <a class="columnMove" href="/history?moveleft=inserted"><img title="Move left" src="skins/leftarrow.gif" border="0" alt="&lt;"></a>
USERCONFIGIS admin html_columns +inserted,+from,+to,-cc,+subject,-date,-size,+bucket

# Column size

MATCH         (Archive Copy) RE: CW v9 and armlets...
USERCONFIGIS  admin html_column_characters 39
CLICK         increase
MATCH         (Archive Copy) RE: CW v9 and armlets...
USERCONFIGIS  admin html_column_characters 40

CLICK         decrease
MATCH         (Archive Copy) RE: CW v9 and armlets...
USERCONFIGIS  admin html_column_characters 39
SETUSERCONFIG admin html_column_characters 6
USERCONFIGIS  admin html_column_characters 6
CLICK         decrease
CLICK         decrease
MATCH         test...
USERCONFIGIS  admin html_column_characters 5

CLICK         automatic
MATCH         (Archive Copy) RE: CW v9 and armlets...
USERCONFIGIS  admin html_column_characters 0

# History Page

GET /history

# Check for existence of messages, check that there
# are links from the bucket names, check that the basic
# sort options are present

MATCH &quot;Dr. Robert Ezenshtein&quot; &lt;phrekiesomeone\@
MATCH &quot;Sheck-Buy&quot; &lt;ADV\@Sheck-Buy.com&gt;
MATCH &lt;from header missing&gt;
MATCH &quot;Becky&quot;  &lt;81355329526\@mail2.great-babes-online.com&gt;
MATCH &quot;Willie Eason&quot; &lt;5x8njuc1ydwu\@mail2Honey.com&gt;
MATCH test\@test.com
MATCH &quot;MARGIT&quot; &lt;cxcse231\@yahoo.com&gt;
MATCH Sascha Schwabbauer &lt;cybersystem\@gentoo.o...
MATCH &lt;bugs\@drnn.net&gt;
MATCH &lt;elia\@tpkm.ru&gt;
MATCH hottest_site_on_net22840\@yahoo.com
MATCH wendyoufp\@msn.com
MATCH Douglas Arnold &lt;0noy8\@worldnet.att.net&gt;
MATCH RN &lt;rrr\@nnnnnnnnn.com&gt;
MATCH Brianna121 &lt;Brianna121\@aol.com&gt;
MATCH &quot;Acaynya&quot;&lt;hornydarla3553qqoe1\@free.fr&gt;

MATCH asdfsomebody\@mbnet.fi
MATCH &lt;to header missing&gt;
MATCH xxx\@xxx.net
MATCH &quot;Willie Eason&quot; &lt;5x8njuc1ydwu\@mail2Honey....
MATCH someone\@somewhere.com
MATCH >dsmith\@ctaz.com, dsmith\@dol.net, dsmith\@...
MATCH gentoo-announce\@gentoo.org
MATCH elia\@tpkm.ru, rescuebre\@tpkm.ru, kcruz\@rltvty.com, bugtracker\@rltvty.com
MATCH rescuebre\@tpkm.ru, bugs\@drnn.net, kcruz\@rltvty.com, bugtracker\@rltvty.com
MATCH &lt;Undisclosed Recipients&gt;
MATCH cfzvcvhr\@worldnet.att.net
MATCH &quot;Armlet Forum&quot; &lt;armlet-forum\@news.palmos.com&gt;
MATCH &lt;webmaster\@jgc.org&gt;
MATCH spamaddy\@domain

MATCH Re[69537]: Information for YOU
MATCH ADV: Turn Back the Hands of Time - Compl...
MATCH Luscious Black Nymphos!
MATCH test for various HTML parts
MATCH Enlarge your package Doctor ApprovedNHOB...
MATCH Fix for kde 3.1+3.0.x installs (x86) (bu..
MATCH VI ID: 24149  Status: Dev Confirmed Fix ..
MATCH VI ID: 24052  Status: Open  Sev: 2
MATCH Mooo
MATCH 5uj9s
MATCH (Archive Copy) RE: CW v9 and armlets..
MATCH [spam] Want to see a huge horse c*ck in ...
MATCH spamaddy,what ?
MATCH &lt;subject header missing&gt;
MATCH blank
MATCH
<span style="color:blue">
spam
</span>
ENDMATCH
MATCH &lt;&nbsp;Arrived
MATCH <a href="/history?setsort=from"

# Check the page navigator

MATCH
Jump to page:
<b>1</b>
[<a href="/history?start_message=20&amp;sort=-inserted">2</a>]
[<a href="/history?start_message=20&amp;sort=-inserted">Next &gt;</a>]
ENDMATCH
MATCH asdfsomebody\@mbnet.fi
MATCH &lt;to header missing&gt;
MATCH xxx\@xxx.net
MATCH &quot;Willie Eason&quot; &lt;5x8njuc1ydwu\@mail2Honey....
MATCH someone\@somewhere.com
MATCH >dsmith\@ctaz.com, dsmith\@dol.net, dsmith\@...
MATCH gentoo-announce\@gentoo.org
MATCH elia\@tpkm.ru, rescuebre\@tpkm.ru, kcruz\@rltvty.com, bugtracker\@rltvty.com
MATCH rescuebre\@tpkm.ru, bugs\@drnn.net, kcruz\@rltvty.com, bugtracker\@rltvty.com
MATCH &lt;Undisclosed Recipients&gt;
MATCH cfzvcvhr\@worldnet.att.net
MATCH &quot;Armlet Forum&quot; &lt;armlet-forum\@news.palmos.com&gt;
MATCH &lt;webmaster\@jgc.org&gt;
MATCH spamaddy\@domain

GET /history?start_message=20&amp;sort=-inserted
MATCH
Jump to page:
[<a href="/history?start_message=0&amp;sort=-inserted">&lt; Previous</a>]
[<a href="/history?start_message=0&amp;sort=-inserted">1</a>]
<b>2</b>
ENDMATCH
MATCH XoSeXyGoDdEsSm\@hotmail.com
MATCH from: Leandro
NOTMATCH asdfsomebody\@mbnet.fi
MATCH &lt;to header missing&gt;
NOTMATCH xxx\@xxx.net
NOTMATCH &quot;Willie Eason&quot; &lt;5x8njuc1ydwu\@mail2Honey....
NOTMATCH someone\@somewhere.com
NOTMATCH >dsmith\@ctaz.com, dsmith\@dol.net, dsmith\@...
NOTMATCH gentoo-announce\@gentoo.org
NOTMATCH elia\@tpkm.ru, rescuebre\@tpkm.ru, kcruz\@rltvty.com, bugtracker\@rltvty.com
NOTMATCH rescuebre\@tpkm.ru, bugs\@drnn.net, kcruz\@rltvty.com, bugtracker\@rltvty.com
NOTMATCH &lt;Undisclosed Recipients&gt;
NOTMATCH cfzvcvhr\@worldnet.att.net
NOTMATCH &quot;Armlet Forum&quot; &lt;armlet-forum\@news.palmos.com&gt;
NOTMATCH &lt;webmaster\@jgc.org&gt;
NOTMATCH spamaddy\@domain

SETSUBMIT jumptopage 1
MATCH
Jump to page:
<b>1</b>
[<a href="/history?start_message=20&amp;sort=-inserted">2</a>]
[<a href="/history?start_message=20&amp;sort=-inserted">Next &gt;</a>]
ENDMATCH
MATCH Douglas Arnold &lt;0noy8\@worldnet.att.net&gt;
MATCH asdfsomebody\@mbnet.fi
MATCH &lt;to header missing&gt;
MATCH xxx\@xxx.net
MATCH &quot;Willie Eason&quot; &lt;5x8njuc1ydwu\@mail2Honey....
MATCH someone\@somewhere.com
MATCH >dsmith\@ctaz.com, dsmith\@dol.net, dsmith\@...
MATCH gentoo-announce\@gentoo.org
MATCH elia\@tpkm.ru, rescuebre\@tpkm.ru, kcruz\@rltvty.com, bugtracker\@rltvty.com
MATCH rescuebre\@tpkm.ru, bugs\@drnn.net, kcruz\@rltvty.com, bugtracker\@rltvty.com
MATCH &lt;Undisclosed Recipients&gt;
MATCH cfzvcvhr\@worldnet.att.net
MATCH &quot;Armlet Forum&quot; &lt;armlet-forum\@news.palmos.com&gt;
MATCH &lt;webmaster\@jgc.org&gt;
MATCH spamaddy\@domain

SETSUBMIT jumptopage 3
MATCH
Jump to page:
<b>1</b>
[<a href="/history?start_message=20&amp;sort=-inserted">2</a>]
[<a href="/history?start_message=20&amp;sort=-inserted">Next &gt;</a>]
ENDMATCH
MATCH Douglas Arnold &lt;0noy8\@worldnet.att.net&gt;
MATCH asdfsomebody\@mbnet.fi
MATCH &lt;to header missing&gt;
MATCH xxx\@xxx.net
MATCH &quot;Willie Eason&quot; &lt;5x8njuc1ydwu\@mail2Honey....
MATCH someone\@somewhere.com
MATCH >dsmith\@ctaz.com, dsmith\@dol.net, dsmith\@...
MATCH gentoo-announce\@gentoo.org
MATCH elia\@tpkm.ru, rescuebre\@tpkm.ru, kcruz\@rltvty.com, bugtracker\@rltvty.com
MATCH rescuebre\@tpkm.ru, bugs\@drnn.net, kcruz\@rltvty.com, bugtracker\@rltvty.com
MATCH &lt;Undisclosed Recipients&gt;
MATCH cfzvcvhr\@worldnet.att.net
MATCH &quot;Armlet Forum&quot; &lt;armlet-forum\@news.palmos.com&gt;
MATCH &lt;webmaster\@jgc.org&gt;
MATCH spamaddy\@domain

SETSUBMIT jumptopage 0
MATCH
Jump to page:
<b>1</b>
[<a href="/history?start_message=20&amp;sort=-inserted">2</a>]
[<a href="/history?start_message=20&amp;sort=-inserted">Next &gt;</a>]
ENDMATCH
MATCH asdfsomebody\@mbnet.fi
MATCH &lt;to header missing&gt;
MATCH xxx\@xxx.net
MATCH &quot;Willie Eason&quot; &lt;5x8njuc1ydwu\@mail2Honey....
MATCH someone\@somewhere.com
MATCH >dsmith\@ctaz.com, dsmith\@dol.net, dsmith\@...
MATCH gentoo-announce\@gentoo.org
MATCH elia\@tpkm.ru, rescuebre\@tpkm.ru, kcruz\@rltvty.com, bugtracker\@rltvty.com
MATCH rescuebre\@tpkm.ru, bugs\@drnn.net, kcruz\@rltvty.com, bugtracker\@rltvty.com
MATCH &lt;Undisclosed Recipients&gt;
MATCH cfzvcvhr\@worldnet.att.net
MATCH &quot;Armlet Forum&quot; &lt;armlet-forum\@news.palmos.com&gt;
MATCH &lt;webmaster\@jgc.org&gt;
MATCH spamaddy\@domain

GET /history

# Check refresh

NOTMATCH Testing Refresh
MATCH (<a class="history" href="/history">Refresh</a>)
NEWMSG 1
GET /history
MATCH John
MATCH Testing Refresh
MATCH personal

# Check magnet classified mails

NOTMATCH Magnetic Attraction for Ferrous Females
MATCH (<a class="history" href="/history">Refresh</a>)
NEWMSG 2
GET /history?setfilter=
MATCH foo-magnet\@magnetmania.com
MATCH Magnetic Attraction for Ferrous Females
MATCH personal
MATCH <img title="From:foo" alt="From:foo" src="/skins/magnet.png">

GET /view?view=32&amp;start_message=0
MATCH Single Message View
MATCH foo-magnet\@magnetmania.com
MATCH Magnetic Attraction for Ferrous Females
MATCH
<b>
Magnet used:
</b>
</font>
<font size="+1">
From:foo
</font>
ENDMATCH

MATCH <a class="messageLink" href="#message_header">Message Header</a>
NOTMATCH | <a class="messageLink" href="#message_body">Message Body</a>
NOTMATCH | <a class="messageLink" href="#quick_magnet">QuickMagnet</a>
NOTMATCH | <a class="messageLink" href="#scores">Scores</a>
MATCH <a name="message_header" />

# Check search

GET /history
SETSUBMIT search isnotpresent
MATCH No messages.
NOTMATCH Jump to page
CLICK reset_filter_search
NOTMATCH searched for from/subject
NOTMATCH No messages.
MATCH Douglas Arnold &lt;0noy8\@worldnet.att.net&gt;
MATCH Jump to page

SETSUBMIT search test.com
MATCH test\@test.com
NOTMATCH Enlarge your package Doctor ApprovedNHOB...
NOTMATCH Jump to page
CLICK reset_filter_search
NOTMATCH searched for from/subject
NOTMATCH No messages.
MATCH Douglas Arnold &lt;0noy8\@worldnet.att.net&gt;
MATCH Jump to page

SETSUBMIT search Doctor
NOTMATCH test\@test.com
MATCH Enlarge your package Doctor ApprovedNHOB...
NOTMATCH Jump to page
CLICK reset_filter_search
NOTMATCH No messages.
MATCH Douglas Arnold &lt;0noy8\@worldnet.att.net&gt;
MATCH Jump to page

# Check search filter highlight

NOTMATCH historySearchFilterActive
SETCONFIG html_search_filter_highlight 1
SETSUBMIT search Doctor
MATCH historySearchFilterActive
SETCONFIG html_search_filter_highlight 0
SETSUBMIT search Doctor
NOTMATCH historySearchFilterActive
CLICK reset_filter_search
NOTMATCH historySearchFilterActive

# Check filter

SETINPUT filter personal
CLICK setfilter
MATCH <option value="personal" selected style="color: green">
NOTMATCH Douglas Arnold &lt;0noy8\@worldnet.att.net&gt;
MATCH Testing Refresh
CLICK reset_filter_search
SETINPUT filter spam
CLICK setfilter
MATCH Douglas Arnold &lt;0noy8\@worldnet.att.net&gt;
NOTMATCH Testing Refresh
MATCH
Jump to page:
<b>1</b>
[<a href="/history?start_message=20&amp;filter=spam&amp;sort=-inserted">2</a>]
[<a href="/history?start_message=20&amp;filter=spam&amp;sort=-inserted">Next &gt;</a>]
ENDMATCH

GET /history?start_message=20&amp;filter=spam
NOTMATCH Testing Refresh
SETINPUT filter other
CLICK setfilter
MATCH No messages.
SETINPUT filter __filter__magnet
CLICK setfilter
MATCH Magnetic Attraction for Ferrous Females
NOTMATCH Testing Refresh
HIDDEN 0
SETINPUTN negate 2 on
CLICK setfilter
NOTMATCH Magnetic Attraction for Ferrous Females
MATCH Testing Refresh
SETINPUTN negate 2 off
CLICK setfilter
MATCH Magnetic Attraction for Ferrous Females
NOTMATCH Testing Refresh
CLICK setfilter
MATCH Magnetic Attraction for Ferrous Females
NOTMATCH Testing Refresh
CLICK reset_filter_search

# Check search filter highlight

NOTMATCH historySearchFilterActive
SETCONFIG html_search_filter_highlight 1
SETINPUT filter spam
CLICK setfilter
MATCH historySearchFilterActive
SETCONFIG html_search_filter_highlight 0
SETINPUT filter spam
CLICK setfilter
NOTMATCH historySearchFilterActive
CLICK reset_filter_search
NOTMATCH historySearchFilterActive

# Check that reclassification doesn't clear the negate
# flag

HIDDEN 0
SETINPUT filter __filter__magnet
SETINPUTN negate 2 on
CLICK setfilter
NOTMATCH Magnetic Attraction for Ferrous Females
MATCH Testing Refresh
CLICK change
NOTMATCH Magnetic Attraction for Ferrous Females
MATCH Testing Refresh
CLICK reset_filter_search

# Check sorting

MATCH
<a href="/history?setsort=bucket" title="Sort by this column">
Bucket
</a>
ENDMATCH

GET /history?setsort=bucket
MATCH
<td>
<a href="/buckets?showbucket=personal">
<span style="color:green">
personal
</span>
</a>
</td>
ENDMATCH
MATCH
<th class="historyLabel">
<a href="/history?setsort=-bucket" title="Sort by this column">
<em class="historyLabelSort">
&gt;&nbsp;Bucket
</em>
</a>
</th>
ENDMATCH

GET /history?setsort=-bucket
MATCH
<th class="historyLabel">
<a href="/history?setsort=bucket" title="Sort by this column">
<em class="historyLabelSort">
&lt;&nbsp;Bucket
</em>
</a>
</th>
ENDMATCH

GET /history?setsort=

# Check reclassification

GET /history
MATCH Testing Refresh
SETINPUT reclassify_31 spam
CLICK change
MATCH Changed to <font color="blue">spam</font>
MATCH Reclassified

# Check reclassified filter

GET /history
SETINPUT filter __filter__reclassified
CLICK setfilter
MATCH <option value="__filter__reclassified" selected>
MATCH Testing Refresh
MATCH <span class="reclassifyText">Reclassified</span>
NOTMATCH Magnetic Attraction

SETINPUTN negate 2 on
CLICK setfilter
MATCH <option value="__filter__reclassified" selected>
MATCH Magnetic Attraction
NOTMATCH <span class="reclassifyText">Reclassified</span>
NOTMATCH Testing Refresh

CLICK reset_filter_search
MATCH <option value="__filter__reclassified" >
MATCH Testing Refresh
MATCH Magnetic Attraction

# Check undo

CLICK undo_31
MATCH
<td>
<a class="messageLink" title="Testing Refresh" href="/view?view=31&amp;start_message=0&amp;sort=-inserted">
<span title="Testing Refresh">Testing Refresh</span></a>
</td>
<td>
<a href="/buckets?showbucket=personal">
<span style="color:green">
personal
</span>
</a>
</td>
ENDMATCH

# Check click through from bucket name

MATCH
<td>
<a href="/buckets?showbucket=spam">
<span style="color:blue">
spam
</span>
</a>
</td>
ENDMATCH

# bucket page

GET /buckets?showbucket=spam
MATCH Detail for <span style="color:blue">spam</span>

GET /history

# Single message view for accuracy

MATCH
<td>
<a class="messageLink" title="Testing Refresh" href="/view?view=31&amp;start_message=0&amp;sort=-inserted">
<span title="Testing Refresh">Testing Refresh</span></a>
</td>
ENDMATCH

GET /view?view=31&amp;start_message=0
MATCH Single Message View
MATCH Testing Refresh
MATCH John
MATCH
<td>
<font size="+1">
<b>
Bucket:
</b>
</font>
</td>
<td>
<font size="+1">
<span style="color:green">
personal
</span>
</font>
</td>
ENDMATCH

MATCH
<a class="messageLink" href="#message_header">Message Header</a>
| <a class="messageLink" href="#message_body">Message Body</a>
| <a class="messageLink" href="#quick_magnets">QuickMagnets</a>
| <a class="messageLink" href="#scores">Scores</a>
ENDMATCH
MATCH <a name="message_header" />
MATCH <a name="message_body" />
MATCH
<a name="quick_magnets">
QuickMagnets
</a>
ENDMATCH
MATCH
<a name="scores">
Scores
</a>
ENDMATCH

MATCH Scores
MATCH 0.769209
MATCH 0.230763
MATCH 2.829186e-05
MATCH <b style="color:red">here</b>
NOTMATCH 0.3289
NOTMATCH 0.6697
MATCH <b style="color:black">John</b>
MATCH Body would

GET /view?view=31&amp;start_message=0&amp;format=prob
MATCH showing word probabilities
MATCH 0.7692
MATCH 0.2308

GET /view?view=31&amp;start_message=0&amp;format=freq
MATCH showing word frequencies
MATCH 0.00165
MATCH 0.00336

GET /view?view=31&amp;start_message=0&amp;format=score
MATCH showing word scores
MATCH 2.3639
MATCH 2.6727

GET   /view?view=31&amp;text=1
MATCH From: John
MATCH Subject: Testing Refresh
MATCH Body would go here

# Jump to message

GET /jump_to_message?view=31
MATCH Single Message View
MATCH Testing Refresh
MATCH John
MATCH
<td>
<font size="+1">
<span style="color:green">
personal
</span>
</font>
</td>
ENDMATCH
MATCH Scores
MATCH 0.769209
MATCH 0.230763
MATCH 2.829186e-05
MATCH <b style="color:red">here</b>
NOTMATCH 0.3289
NOTMATCH 0.6697
MATCH <b style="color:black">John</b>
MATCH Body would

GET /jump_to_message?view=40
NOTMATCH Single Message View
MATCH Recent Messages

# jump_to_message and a password

GET /history
SETINPUT new_password secret
SETINPUT confirm_password secret
CLICK    change_password
MATCH    New password has been set
GET /logout

GET /jump_to_message?view=31
SETSUBMIT password secret
MATCH Single Message View
MATCH Testing Refresh
GET /history

SETINPUT old_password secret
SETINPUT new_password
SETINPUT confirm_password
CLICK    change_password
MATCH    New password has been set

# Quick Magnets

GET /jump_to_message?view=31
MATCH Single Message View
MATCH
<option value="Testing">
Testing
</option>
ENDMATCH
MATCH
<option value="Refresh">
Refresh
</option>
ENDMATCH
MATCH
<option value="John">
John
</option>
ENDMATCH
SETINPUT text1 John
SETINPUT bucket1 other
CLICK create
MATCH Current Magnets
MATCH <input type="text" name="text1" value="John" size="50" />
SETINPUT remove1 on
CLICK delete

# Reclassify from single message view

GET /view?view=31&amp;start_message=0
MATCH Single Message View
MATCH Testing Refresh
SETINPUT reclassify_31 spam
CLICK change
MATCH Changed to <font color="blue">spam</font>

# Undo on single message view

GET /view?view=31&amp;start_message=0
MATCH Single Message View
CLICK undo_31
MATCH
<td>
<a class="messageLink" title="Testing Refresh" href="/view?view=31&amp;start_message=0">
<span title="Testing Refresh">Testing Refresh</span></a>
</td>
<td>
<a href="/buckets?showbucket=personal">
<span style="color:green">
personal
</span>
</a>
</td>
ENDMATCH

# Check delete one message

GET /history
MATCH    Testing Refresh
SETINPUT remove_31 on
CLICK    clearchecked
MATCH    Recent Messages
NOTMATCH Testing Refresh

# Check delete some messages

MATCH    foo-magnet\@magnetmania.com
MATCH    Dr. Robert Ezenshtein
SETINPUT remove_30 on
SETINPUT remove_32 on
CLICK    clearchecked
NOTMATCH foo-magnet\@magnetmania.com
NOTMATCH Dr. Robert Ezenshtein

# Check delete page of messages

GET /history
CLICK clearpage
NOTMATCH Jump to message
MATCH Recent Messages (9)
MATCH Luke Perry
MATCH serafina venter

# Check delete all messages

CLICK clearall
MATCH No messages.

# Magnets Page

GET /magnets

# Check that predefined magnets are present

INPUTIS text1 foo
INPUTIS bucket1 personal
INPUTIS type1 from
INPUTIS text2 oldstyle
INPUTIS bucket2 personal
INPUTIS type2 from
INPUTIS text3 bar
INPUTIS bucket3 personal
INPUTIS type3 subject
INPUTIS text4 baz\@baz.com
INPUTIS bucket4 personal
INPUTIS type4 to

# Check magnet creation

SETINPUT  text0 newmagnet
SETINPUT  type0 subject
SETSUBMIT bucket0 spam
INPUTIS   text5 newmagnet
INPUTIS   type5 subject
INPUTIS   bucket5 spam
MAGNETIS  spam subject newmagnet

SETINPUT  text0 foo
SETINPUT  type0 from
SETSUBMIT bucket0 personal
MATCH     Magnet &#39;from: foo&#39; already exists in bucket &#39;personal&#39;

SETINPUT  text0 foo bar
SETINPUT  type0 from
SETSUBMIT bucket0 personal
MATCH     New magnet &#39;from: foo bar&#39; clashes with magnet &#39;from: foo&#39; in bucket &#39;personal&#39; and could cause ambiguous results.  New magnet was not added.

# Check magnet change value

SETSUBMIT text5 newmagnetvalue
INPUTIS   text5 newmagnetvalue
INPUTIS   type5 subject
INPUTIS   bucket5 spam
MAGNETIS  spam subject newmagnetvalue
INPUTIS   text1 foo
INPUTIS   bucket1 personal
INPUTIS   type1 from
INPUTIS   text2 oldstyle
INPUTIS   bucket2 personal
INPUTIS   type2 from
INPUTIS   text3 bar
INPUTIS   bucket3 personal
INPUTIS   type3 subject
INPUTIS   text4 baz\@baz.com
INPUTIS   bucket4 personal
INPUTIS   type4 to

# Check magnet change type

SETSUBMIT type5 to
INPUTIS   type5 to
INPUTIS   text5 newmagnetvalue
INPUTIS   bucket5 spam
MAGNETIS  spam to newmagnetvalue
INPUTIS   text1 foo
INPUTIS   bucket1 personal
INPUTIS   type1 from
INPUTIS   text2 oldstyle
INPUTIS   bucket2 personal
INPUTIS   type2 from
INPUTIS   text3 bar
INPUTIS   bucket3 personal
INPUTIS   type3 subject
INPUTIS   text4 baz\@baz.com
INPUTIS   bucket4 personal
INPUTIS   type4 to

# Check magnet change bucket

SETSUBMIT bucket5 personal
INPUTIS   bucket5 personal
INPUTIS   text5 newmagnetvalue
INPUTIS   type5 to
MAGNETIS  personal to newmagnetvalue
INPUTIS   text1 foo
INPUTIS   bucket1 personal
INPUTIS   type1 from
INPUTIS   text2 oldstyle
INPUTIS   bucket2 personal
INPUTIS   type2 from
INPUTIS   text3 bar
INPUTIS   bucket3 personal
INPUTIS   type3 subject
INPUTIS   text4 baz\@baz.com
INPUTIS   bucket4 personal
INPUTIS   type4 to

# Check the magnet navigator

GET /history
SETSUBMIT page_size 3

GET /magnets
MATCH
Jump to magnet page:
<b>1</b>
[<a href="/magnets?start_magnet=3">2</a>]
[<a href="/magnets?start_magnet=3">Next</a>]
ENDMATCH

GET /magnets?start_magnet=3
MATCH
Jump to magnet page:
[<a href="/magnets?start_magnet=0">Previous</a>]
[<a href="/magnets?start_magnet=0">1</a>]
<b>2</b>
ENDMATCH

GET /history
SETSUBMIT page_size 20

# Check magnet deletion

GET /magnets
SETINPUT remove5 on
CLICK delete
MATCH Removed the magnet &#39;to: newmagnetvalue&#39; from bucket &#39;personal&#39;
NOTMATCH "newmagnetvalue"
NOTMATCH type5

SETINPUT remove1 on
SETINPUT remove3 on
CLICK    delete
NOTMATCH "foo"
NOTMATCH "bar"
INPUTIS  text1 oldstyle
INPUTIS  bucket1 personal
INPUTIS  type1 from
INPUTIS  text2 baz\@baz.com
INPUTIS  bucket2 personal
INPUTIS  type2 to
NOTMATCH type3

# Administration Page

GET /administration

# Check logger change

INPUTIS   debug 2
CONFIGIS  GLOBAL_debug 1
SETSUBMIT debug 3
INPUTIS   debug 3
CONFIGIS  GLOBAL_debug 2
MATCH     The current logger output : &#39;To Screen (console)&#39;
SETSUBMIT debug 4
INPUTIS   debug 4
CONFIGIS  GLOBAL_debug 3
MATCH     The current logger output : &#39;To Screen and File&#39;
SETSUBMIT debug 1
INPUTIS   debug 1
CONFIGIS  GLOBAL_debug 0
MATCH     The current logger output : &#39;None&#39;

# Check logger level change

INPUTIS   level 0
CONFIGIS  logger_level 0
SETSUBMIT level 1
INPUTIS   level 1
CONFIGIS  logger_level 1
MATCH     The current logger level : &#39;Medium&#39;
SETSUBMIT level 2
INPUTIS   level 2
CONFIGIS  logger_level 2
MATCH     The current logger level : &#39;High&#39;
SETSUBMIT level 0
INPUTIS   level 0
CONFIGIS  logger_level 0
MATCH     The current logger level : &#39;Low&#39;

# Check change timeout

INPUTIS   timeout 60
CONFIGIS  GLOBAL_timeout 60
SETSUBMIT timeout 61
INPUTIS   timeout 61
CONFIGIS  GLOBAL_timeout 61
MATCH Updated connection timeout to 61
SETSUBMIT timeout 0
MATCH The TCP timeout must be a number between 10 and 1800
INPUTIS   timeout 61

# Check change session timeout

INPUTIS   session_timeout 1800
CONFIGIS  GLOBAL_session_timeout 1800
SETSUBMIT session_timeout 1801
INPUTIS   session_timeout 1801
CONFIGIS  GLOBAL_session_timeout 1801
MATCH Updated session timeout to 1801
SETSUBMIT session_timeout 0
MATCH The session timeout must be a number between 300 and 86400
INPUTIS   session_timeout 1801

# Check change POP3 port

INPUTIS   pop3_port 9110
CONFIGIS  pop3_port 9110
SETSUBMIT pop3_port 111
INPUTIS   pop3_port 111
CONFIGIS  pop3_port 111
MATCH Updated POP3 port to 111; this change will not take affect until you restart POPFile
SETSUBMIT pop3_port 0
MATCH The POP3/POP3S listen port must be a number between 1 and 65535
INPUTIS   pop3_port 111
SETSUBMIT pop3_port $port
MATCH The POP3 listen port cannot be the same value as the user interface port
INPUTIS   pop3_port 111

# Check change separator

INPUTIS   pop3_separator :
CONFIGIS  pop3_separator :
SETSUBMIT pop3_separator ;
INPUTIS   pop3_separator ;
CONFIGIS  pop3_separator ;
MATCH Updated POP3 separator to ;
SETSUBMIT pop3_separator gg
MATCH The separator character must be a single character
INPUTIS   pop3_separator ;

# Check fork for POP3

INPUTIS   pop3_force_fork
CONFIGIS  pop3_force_fork 0
SETSUBMIT pop3_force_fork 1
INPUTIS   pop3_force_fork 1
CONFIGIS  pop3_force_fork 1
MATCH     Enabled concurrent POP3 connections
SETSUBMIT pop3_force_fork off
INPUTIS   pop3_force_fork
CONFIGIS  pop3_force_fork 0
MATCH     Disabled concurrent POP3 connections

# Check UI port

INPUTIS   ui_port $port
CONFIGIS  html_port $port
SETSUBMIT ui_port 8082
INPUTIS   ui_port 8082
CONFIGIS  html_port 8082
MATCH Updated user interface web port to 8082; this change will not take affect until you restart POPFile
SETSUBMIT ui_port 0
MATCH The user interface port must be a number between 1 and 65535
INPUTIS   ui_port 8082
SETSUBMIT ui_port 111
MATCH The user interface port cannot be the same value as the POP3 listen port
INPUTIS   ui_port 8082

# Check POP3 stealth

INPUTIS   serveropt_pop3
CONFIGIS  pop3_local 1
SETSUBMIT serveropt_pop3 on
INPUTIS   serveropt_pop3 on
CONFIGIS  pop3_local 0
MATCH     POPFile POP3 proxy ALLOWS to be accessed from another machine; this change will not take affect until you restart POPFile
SETSUBMIT serveropt_pop3 off
INPUTIS   serveropt_pop3
CONFIGIS  pop3_local 1
MATCH     POPFile POP3 proxy WON&#39;T be accessed from another machine; this change will not take affect until you restart POPFile

# Check UI stealth
INPUTIS   serveropt_html
CONFIGIS  html_local 1
SETSUBMIT serveropt_html on
INPUTIS   serveropt_html on
CONFIGIS  html_local 0
MATCH     POPFile UI (Control center) ALLOWS to be accessed from another machine; this change will not take affect until you restart POPFile
SETSUBMIT serveropt_html off
INPUTIS   serveropt_html
CONFIGIS  html_local 1
MATCH     POPFile UI (Control center) WON&#39;T be accessed from another machine; this change will not take affect until you restart POPFile

# Check POP3 AUTH options

INPUTIS   server
CONFIGIS  pop3_secure_server
SETSUBMIT server secure.com
INPUTIS   server secure.com
CONFIGIS  pop3_secure_server secure.com
MATCH Updated remote POP3 server to secure.com

INPUTIS   sport 110
CONFIGIS  pop3_secure_port 110
SETSUBMIT sport 111
INPUTIS   sport 111
CONFIGIS  pop3_secure_port 111
MATCH Updated remote POP3 server port to 111
SETSUBMIT sport 0
INPUTIS   sport 111
CONFIGIS  pop3_secure_port 111
MATCH The port must be a number between 1 and 65535

# Check autoupdate

INPUTIS      update_check
USERCONFIGIS admin html_update_check 0
SETSUBMIT    update_check on
INPUTIS      update_check on
USERCONFIGIS admin html_update_check 1
MATCH        POPFile checks for updates daily
SETSUBMIT    update_check off
INPUTIS      update_check
USERCONFIGIS admin html_update_check 0
MATCH        POPFile does not check for updates automatically

# Check statistics sending

INPUTIS      send_stats
USERCONFIGIS admin html_send_stats 0
SETSUBMIT    send_stats on
INPUTIS      send_stats on
MATCH        POPFile sends classification statistics daily
USERCONFIGIS admin html_send_stats 1
SETSUBMIT    send_stats off
INPUTIS      send_stats
USERCONFIGIS admin html_send_stats 0
MATCH        POPFile does not send classification statistics

# Check password

GET /history
ISVALIDPASSWORD
SETINPUT        new_password secret
SETSUBMIT       confirm_password secret
ISVALIDPASSWORD secret
SETSUBMIT       old_password secret
ISVALIDPASSWORD

# Advanced Page

GET /advanced

# Check presence of ignore words

MATCH address
MATCH localhost
MATCH smtp

# Check add ignore word

INPUTIS   newword
SETSUBMIT newword four11@.-_
MATCH &#39;four11@.-_&#39; added to the Ignored Words list
# reload
GET /advanced
MATCH four11@.-_
SETSUBMIT newword ba"d
MATCH Ignored words can only contain alphanumeric, ., _, -, or @ characters

# Check remove ignore word

INPUTIS   word
SETSUBMIT word four11@.-_
MATCH &#39;four11@.-_&#39; removed from the Ignored Words list
# reload
GET /advanced
NOTMATCH  four11@.-_
SETSUBMIT word ba"d
MATCH Ignored words can only contain alphanumeric, ., _, -, or @ characters

# TODO Write better tests for stop words in Japanese
# and Korean

GET /administration
SETSUBMIT language Nihongo
GET /advanced
MATCH address
MATCH localhost
MATCH smtp

GET /administration
SETSUBMIT language Korean
GET /advanced
MATCH address
MATCH localhost
MATCH smtp

GET /administration
SETSUBMIT language English

# Check change arbitrary parameter

GET /advanced
SETSUBMIT parameter_bayes_hostname testhostname
CONFIGIS  bayes_hostname testhostname
INPUTIS   parameter_bayes_hostname testhostname

# Single user mode parameters

GET /advanced
MATCH Single User Mode Parameters

SETSUBMIT parameter_bayes_unclassified_weight 1000
USERCONFIGIS admin bayes_unclassified_weight 1000
INPUTIS   parameter_bayes_unclassified_weight 1000

# Buckets Page

GET /buckets

# Basic bucket test to verify that the buckets in the test corpus
# are present on the bucket page with the right numbers
#
#     Checks bucket names are present and the word and unique word
#     counts

MATCH spam
MATCH personal
MATCH other

MATCH <a href="/buckets?showbucket=spam">
MATCH <a href="/buckets?showbucket=personal">
MATCH <a href="/buckets?showbucket=other">

MATCH
<td align="right">
656
</td>
ENDMATCH
MATCH
<td align="right">
3
</td>
ENDMATCH
MATCH
<td align="right">
3,353
</td>
ENDMATCH

# Check statistics displayed correctly

MATCH
<td align="right">
1,785 (12.74%)
</td>
ENDMATCH
MATCH
<td align="right">
103 (0.73%)
</td>
ENDMATCH
MATCH
<td align="right">
12,114 (86.51%)
</td>
ENDMATCH

MATCH
<td bgcolor="red" title="other (12.75)" width="12.75%" height="20">
<img src="pix.gif" alt="" height="20" width="1" />
</td>
ENDMATCH
MATCH
<td bgcolor="green" title="personal (0.74)" width="0.74%" height="20">
<img src="pix.gif" alt="" height="20" width="1" />
</td>
ENDMATCH
MATCH
<td bgcolor="blue" title="spam (86.52)" width="86.52%" height="20">
<img src="pix.gif" alt="" height="20" width="1" />
</td>
ENDMATCH

# Check Reset Statistics

MATCH
<td align="right">
164
</td>
ENDMATCH
MATCH
<td align="right">
1
</td>
ENDMATCH
MATCH
<td align="right">
99.39%
</td>
ENDMATCH
CLICK reset_stats
MATCH
<td align="right">
Not enough data
</td>
ENDMATCH
MATCH
<td align="right">
0 (  0.00%)
</td>
ENDMATCH

# Check bucket creation

NOTMATCH newbucket0-_
SETSUBMIT cname newbucket0-_
MATCH newbucket0-_
MATCH Created bucket named newbucket0-_
MATCH
<td align="left">
<a href="/buckets?showbucket=newbucket0-_">
<span style="color:black">
newbucket0-_
</span>
</a>
</td>
ENDMATCH

SETSUBMIT cname bu%cket
MATCH Bucket names can only contain the letters a to z in lower case
SETSUBMIT cname BUCKET
MATCH Bucket names can only contain the letters a to z in lower case

SETSUBMIT cname spam
MATCH Bucket named spam already exists

MATCH spam
MATCH personal
MATCH other

# Check set bucket color

GET /buckets?newbucket0-__color=blue&amp;bucket_settings=Apply%20Changes
MATCH
<td align="left">
<a href="/buckets?showbucket=newbucket0-_">
<span style="color:blue">
newbucket0-_
</span>
</a>
</td>
ENDMATCH

# Check bucket rename

SETINPUT oname newbucket0-_
SETSUBMIT newname sens%ible
MATCH Bucket names can only contain the letters a to z in lower case
SETINPUT oname newbucket0-_
SETSUBMIT newname sensible
MATCH Renamed bucket newbucket0-_ to sensible
MATCH
<td align="left">
<a href="/buckets?showbucket=sensible">
<span style="color:blue">
sensible
</span>
</a>
</td>
ENDMATCH

MATCH spam
MATCH personal
MATCH other

# Check bucket delete

SETSUBMIT name sensible
MATCH Deleted bucket sensible

GET /buckets

NOTMATCH sensible
MATCH spam
MATCH personal
MATCH other

# Check word lookup

SETSUBMIT word xxxxxx
MATCH <b>xxxxxx</b> does not appear in any of the buckets
SETSUBMIT word used
MATCH <b>used</b> is most likely to appear in <font color="red">other</font>
MATCH 0.0005602241
MATCH 0.6873803233
MATCH 1.8945518529
MATCH Frequency
SETSUBMIT word address
MATCH <b>address</b> is in Ignored Words. POPFile ignores this word

# Check operation of Subject Modification

SETSUBMIT name personal
MATCH Deleted bucket personal
SETSUBMIT name other
MATCH Deleted bucket other

#HIDDEN 1
INPUTIS spam_subject
PARAMETERIS spam subject 0
SETSUBMIT spam_subject off
INPUTIS spam_subject
PARAMETERIS spam subject 0
SETSUBMIT spam_subject on
INPUTIS spam_subject on
PARAMETERIS spam subject 1
#HIDDEN 0

# Check operation of Quarantine

#HIDDEN 1
INPUTIS spam_quarantine
PARAMETERIS spam quarantine 0
SETSUBMIT spam_quarantine on
INPUTIS spam_quarantine on
PARAMETERIS spam quarantine 1
SETSUBMIT spam_quarantine off
INPUTIS spam_quarantine
PARAMETERIS spam quarantine 0
#HIDDEN 0

# Check operation of color change

GET /buckets?spam_color=feldspar&amp;bucket_settings=Apply%20Changes
MATCH <option value="feldspar"  selected style="color: feldspar">

# Check individual bucket page for accuracy

MATCH /buckets?showbucket=spam
GET /buckets?showbucket=spam
MATCH Detail for <span style="color:feldspar">spam</span>
MATCH 12,114
MATCH (3,353 distinct)
MATCH
<td>
100.00%
</td>
ENDMATCH
MATCH <a class="bucketLetter" href="/buckets?showbucket=spam&amp;showletter=m">

GET /buckets?showbucket=spam&amp;showletter=m
MATCH <a class="wordListLink" href="/buckets?lookup=Lookup&amp;word=missouri#Lookup">

# Check clearing of individual bucket

CLICK clearbucket
MATCH
<th scope="row" class="bucketsLabel">
Total word count
</th>
<td>
&nbsp;
</td>
<td>
0
</td>
ENDMATCH

# Cookie test

# Single user mode

SETCOOKIE 123456
GET       /
MATCH     Recent Messages

SETINPUT  old_password
SETINPUT  new_password secret
SETINPUT  confirm_password secret
CLICK     change_password
MATCH     New password has been set

SETCOOKIE 123456
GET       /
MATCH     Login

SETSUBMIT password secret
MATCH     Recent Messages

# invalid cookie1

SETCOOKIE U2FsdGVkX183ySXJbS5ODY1xWaXjA6JXEJyng/Gcxw7xcX/XEqChvbddodaI7xIff47V5z+lW9LYf9+YcnifYchpGxYAQtJOM2mA0lU4eyiUbgdx0tpjmzjdHxzCyO06BGxfqibNotcmhDqxiMzCjYa9J6jVClSXW2PKjrpEvYDNuF435TnO87ucLSDKq3NChNpbyJ448OPco9WYBFx5+g==
GET       /
MATCH     Login

SETSUBMIT password secret
MATCH     Recent Messages

# invalid cookie2

SETCOOKIE U2FsdGVkX183ySXJbS5ODY1xWaXjA6JXEJyng/G;xw7xcX/XEqChvbddodaI7xIff47V5z+lW9LYf9+YcnifYchpGxYAQtJOM2mA0lU4eyiUbgdx0tpjmzjdHxzCyO06BGxfqibNotcmhDqxiMzCjYa9J6jVClSXW2PKjrpEvYDNuF435TnO87ucLSDKq3NChNpbyJ448OPco9WYBFx5+ga=
GET       /
MATCH     Login

SETSUBMIT password secret
MATCH     Recent Messages

SETINPUT  old_password secret
SETINPUT  new_password
SETINPUT  confirm_password
CLICK     change_password
MATCH     New password has been set

# Multiuser mode

GET       /administration
SETINPUT  usermode off
CLICK     apply_stealth

SETCOOKIE 123456
GET       /
MATCH     Login

SETINPUT  username admin
SETSUBMIT password
MATCH     Recent Messages

GET       /administration
SETINPUT  usermode on
CLICK     apply_stealth

#GET /history?session=123456
#MATCH POPFile Session Expired

# Get ICO, GIF, CSS, PNG, LOG and HTML file

CODE
open TEMP, ">../temp.ico";
print TEMP "10 GOTO 10\n";
close TEMP;
ENDCODE

GET /temp.ico
MATCH 10 GOTO 10

CODE
rename '../temp.ico', '../temp.gif';
ENDCODE

GET /temp.gif
MATCH 10 GOTO 10

CODE
rename '../temp.gif', '../temp.png';
ENDCODE

GET /temp.png
MATCH 10 GOTO 10

CODE
unlink '../temp.png';
ENDCODE

GET /popfile_current_log.log
MATCH Attempting to connect to dbi:SQLite:dbname=../tests/popfile.db

CODE
mkdir '../manual';
open TEMP, ">../manual/temp.html";
print TEMP "10 GOTO 10\n";
close TEMP;
ENDCODE

GET /manual/temp.html
MATCH 10 GOTO 10

CODE
rmtree( '../manual' );
ENDCODE

GET /skins/default/style.css
MATCH .menuSelected

# Get a page that does not exist

GET /foo
MATCH POPFile Web Server Error 404

# Check update checking

SETUSERCONFIG admin html_update_check 1
SETUSERCONFIG admin html_send_stats 1
SETUSERCONFIG admin html_last_update_check 0
GET /
MATCH popfile_update.pl
MATCH popfile_stats.pl

# Check the operation of passwords

GET /history
SETINPUT new_password secret
SETINPUT confirm_password secret
CLICK    change_password
MATCH    New password has been set
GET /logout

GET /history
MATCH     <h2 class="password">Login</h2>
SETSUBMIT password wrongpassword
MATCH Incorrect password
GET /history
MATCH     <h2 class="password">Login</h2>
SETSUBMIT password secret
MATCH     Recent Messages

SETINPUT  old_password secret
SETINPUT  new_password
SETINPUT  confirm_password
CLICK     change_password
MATCH     New password has been set

SETINPUT old_password wrongpassword
CLICK    change_password
MATCH    The old password entered is incorrect
SETINPUT old_password
SETINPUT new_password secret
SETINPUT confirm_password wrongconfirmpassword
CLICK    change_password
MATCH    The new password must by identical in the New and Confirm New boxes



# Check shutdown operation

GET /shutdown
MATCH POPFile has shut down
