# ---------------------------------------------------------------------------------------------
#
# Test script for the HTML interface, loaded by TestHTML.tst
#
# Copyright (c) 2003 John Graham-Cumming
#
#   This file is part of POPFile
#
#   POPFile is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   POPFile is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with POPFile; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
#
# ---------------------------------------------------------------------------------------------

# To simplify testing the POPFile HTML UI this file contains a script
# that is read by TestHTML.tst and executed.  The script consists of instructions
# for specific URLs that are to be hit and instructions for how to match the
# result that comes back
#
# The commands are as follows
#
# GET <url>         Get the URL (note the host and port will be added for you)
# MATCH <data>      Match the return from last URL fetch against the data
# NOTMATCH <data>   Must not match the return from last URL fetch against the data
# MATCH/ENDMATCH    Encloses a block of test to find in the return from the last URL fetch
# CODE/ENDCODE      Arbitrary code that should be executed
# INPUTIS a b       Assert that form item a has value b
# SETINPUT a b      Sets the form item a to value b
# SUBMIT a          Finds the form with input a and submits it
# SETSUBMIT a b     Just like doing SETINPUT a b followed by SUBMIT a
# CONFIGIS a b      Verify that config item a has value b
#
# Expect that the following are available to you within the MATCH/ENDMATCH block
#
# $port             The port on which the HTML interface is running
# $url              URL object for the last URL specified
# $content          String containing the return from the last URL fetch
# $sk               The current HTML UI session key
# $version          Same as $h->version()

# Test the simplest functionality of the HTML interface

# Look for elements that should appear at the TOP and BOTTOM
# of every page

GET /

# Common TOP parts

MATCH <title>POPFile Control Center</title>
MATCH <html lang="en">
MATCH <meta http-equiv="Pragma" content="no-cache">
MATCH <meta http-equiv="Expires" content="0">
MATCH <meta http-equiv="Cache-Control" content="no-cache">
MATCH <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
MATCH <link rel="stylesheet" type="text/css" href="skins/SimplyBlue.css" title="SimplyBlue">
MATCH <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
MATCH <link rel="icon" href="popfile.ico" type="image/ico">

# Common MIDDLE parts (i.e. the tabs)

MATCH <a class="menuLink" href="/history?session=$sk&amp;setfilter=">
MATCH History</a>
MATCH <a class="menuLink" href="/buckets?session=$sk">
MATCH Buckets</a>
MATCH <a class="menuLink" href="/magnets?session=$sk&amp;start_magnet=0">
MATCH Magnets</a>
MATCH <a class="menuLink" href="/configuration?session=$sk">
MATCH Configuration</a>
MATCH <a class="menuLink" href="/security?session=$sk">
MATCH Security</a>
MATCH <a class="menuLink" href="/advanced?session=$sk">
MATCH Advanced</a>

# Common BOTTOM parts

MATCH <a class="bottomLink" href="manual/en/manual.html">
MATCH <br>$version<br>

# Verify that each of the pages highlights the correct item on
# the tab bar and hence the simplest level of page serving is working
# correctly

GET /history
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/history?session=$sk&amp;setfilter=">
ENDMATCH

GET /buckets
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/buckets?session=$sk">
ENDMATCH

GET /magnets
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/magnets?session=$sk&amp;start_magnet=0">
ENDMATCH

GET /configuration
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/configuration?session=$sk">
ENDMATCH

GET /security
MATCH 
<td class="menuSelected" align="center">
<a class="menuLink" href="/security?session=$sk">
ENDMATCH

GET /advanced
MATCH
<td class="menuSelected" align="center">
<a class="menuLink" href="/advanced?session=$sk">
ENDMATCH

# TODO History Page

# TODO Check for existence of messages
# TODO Check the page navigator
# TODO Check refresh
# TODO Check search
# TODO Check filter
# TODO Check reclassification
# TODO Check delete some messages
# TODO Check delete page of messages
# TODO Check delete all messages
# TODO Check sorting
# TODO Check click through from bucket name

# TODO single message view for accuracy
# TODO reclassify from single message view

# TODO Buckets Page

# TODO Basic bucket test to verify that the buckets in the test corpus
# are present on the bucket page with the right numbers
# TODO Check statistics displayed correctly
# TODO Check operation of Subject Modification
# TODO Check operation of Quarantine
# TODO Check operation of color change
# TODO Check Reset Statistics
# TODO Check bucket creation
# TODO Check bucket rename
# TODO Check bucket delete
# TODO Check word lookup

# TODO Check individual bucket page for accuracy
# TODO Check clearing of individual bucket

# TODO Magnets Page

# TODO Check that predefined magnets are presetn
# TODO Check magnet creation
# TODO Check magnet change value
# TODO Check magnet change type
# TODO Check magnet change bucket
# TODO Check magnet deletion

# Configuration Page

GET /configuration

# Check skin change

MATCH <link rel="stylesheet" type="text/css" href="skins/SimplyBlue.css" title="SimplyBlue">
CONFIGIS html_skin SimplyBlue
SETSUBMIT skin default
MATCH <link rel="stylesheet" type="text/css" href="skins/default.css" title="default">
CONFIGIS html_skin default

# Check language change

MATCH <html lang="en">
CONFIGIS html_language English
SETSUBMIT language Francais
MATCH <html lang="fr">
CONFIGIS html_language Francais
SETSUBMIT language English
MATCH <html lang="en">
CONFIGIS html_language English

# Check logger change

INPUTIS   debug 2
CONFIGIS  GLOBAL_debug 1
SETSUBMIT debug 3
INPUTIS   debug 3
CONFIGIS  GLOBAL_debug 2
SETSUBMIT debug 4
INPUTIS   debug 4
CONFIGIS  GLOBAL_debug 3
SETSUBMIT debug 1
INPUTIS   debug 1
CONFIGIS  GLOBAL_debug 0

# Check history lines change

INPUTIS   page_size 20
CONFIGIS  html_page_size 20
SETSUBMIT page_size 30
INPUTIS   page_size 30
CONFIGIS  html_page_size 30
MATCH Updated number of messages per page to 30
SETSUBMIT page_size 0
MATCH The page size must be a number between 1 and 1000
INPUTIS   page_size 30

# Check history days change

INPUTIS   history_days 2
CONFIGIS  html_history_days 2
SETSUBMIT history_days 3
INPUTIS   history_days 3
CONFIGIS  html_history_days 3
MATCH Updated number of days of history to 3
SETSUBMIT history_days 0
MATCH The number of days in the history must be a number between 1 and 366
INPUTIS   history_days 3

# Check change timeout

INPUTIS   timeout 60
CONFIGIS  GLOBAL_timeout 60
SETSUBMIT timeout 61
INPUTIS   timeout 61
CONFIGIS  GLOBAL_timeout 61
MATCH Updated connection timeout to 61
SETSUBMIT timeout 0
MATCH The TCP timeout must be a number between 10 and 300
INPUTIS   timeout 61

# Check change POP3 port

INPUTIS   pop3_port 110
CONFIGIS  pop3_port 110
SETSUBMIT pop3_port 111
INPUTIS   pop3_port 111
CONFIGIS  pop3_port 111
MATCH Updated POP3 port to 111; this change will not take affect until you restart POPFile
SETSUBMIT pop3_port 0
MATCH The POP3 listen port must be a number between 1 and 65535
INPUTIS   pop3_port 111

# Check change separator

INPUTIS   pop3_separator :
CONFIGIS  pop3_separator :
SETSUBMIT pop3_separator ;
INPUTIS   pop3_separator ;
CONFIGIS  pop3_separator ;
MATCH Updated POP3 separator to ;
SETSUBMIT pop3_separator gg
MATCH The separator character must be a single character
INPUTIS   pop3_separator ;

# Check Subject Line Modification

INPUTIS subject 1
CONFIGIS GLOBAL_subject 1
SETSUBMIT subject 1
INPUTIS subject 2
CONFIGIS GLOBAL_subject 0

GET /buckets
MATCH Disabled globally

GET /configuration
SETSUBMIT subject 2
INPUTIS subject 1
CONFIGIS GLOBAL_subject 1

# Check XTC

INPUTIS xtc 1
CONFIGIS GLOBAL_xtc 1
SETSUBMIT xtc 1
INPUTIS xtc 2
CONFIGIS GLOBAL_xtc 0
SETSUBMIT xtc 2
INPUTIS xtc 1
CONFIGIS GLOBAL_xtc 1

# Check XPL

INPUTIS xpl 1
CONFIGIS GLOBAL_xpl 1
SETSUBMIT xpl 1
INPUTIS xpl 2
CONFIGIS GLOBAL_xpl 0
SETSUBMIT xpl 2
INPUTIS xpl 1
CONFIGIS GLOBAL_xpl 1

# Check UI port

INPUTIS   ui_port $port
CONFIGIS  html_port $port
SETSUBMIT ui_port 8081
INPUTIS   ui_port 8081
CONFIGIS  html_port 8081
MATCH Updated user interface web port to 8081; this change will not take affect until you restart POPFile
SETSUBMIT ui_port 0
MATCH The user interface port must be a number between 1 and 65535
INPUTIS   ui_port 8081

# TODO Check XMLRPC port (write when doing TestXMLRPC)
# TODO Check SMTP port (write when doing TestSMTP)
# TODO Check NNTP port (write when doing TestNNTP)
# TODO Check NNTP separator (write when doing TestNNTP)
# TODO Check Windows icon

# Security Page

GET /security

# Check POP3 stealth

INPUTIS pop3_local 1
CONFIGIS pop3_local 1
SETSUBMIT pop3_local 1
INPUTIS pop3_local 2
CONFIGIS pop3_local 0
SETSUBMIT pop3_local 2
INPUTIS pop3_local 1
CONFIGIS pop3_local 1

# Check UI stealth

INPUTIS localui 1
CONFIGIS html_local 1
SETSUBMIT localui 1
INPUTIS localui 2
CONFIGIS html_local 0
SETSUBMIT localui 2
INPUTIS localui 1
CONFIGIS html_local 1

# Check POP3 AUTH options

INPUTIS   server
CONFIGIS  pop3_secure_server
SETSUBMIT server secure.com
INPUTIS   server secure.com
CONFIGIS  pop3_secure_server secure.com
MATCH Updated POP3 SPA/AUTH secure server to secure.com; this change will not take affect until you restart POPFile

INPUTIS   sport 110
CONFIGIS  pop3_secure_port 110
SETSUBMIT sport 111
INPUTIS   sport 111
CONFIGIS  pop3_secure_port 111
MATCH Updated POP3 SPA/AUTH port to 111; this change will not take affect until you restart POPFile

# Check autoupdate

INPUTIS update_check 2
CONFIGIS html_update_check 0
SETSUBMIT update_check 1
INPUTIS update_check 2
CONFIGIS html_update_check 0
SETSUBMIT update_check 2
INPUTIS update_check 1
CONFIGIS html_update_check 1

# Check statistics sending

INPUTIS send_stats 2
CONFIGIS html_send_stats 0
SETSUBMIT send_stats 1
INPUTIS send_stats 2
CONFIGIS html_send_stats 0
SETSUBMIT send_stats 2
INPUTIS send_stats 1
CONFIGIS html_send_stats 1

# Check password

INPUTIS password
CONFIGIS html_password
SETSUBMIT password secret
CONFIGIS html_password secret
MATCH Updated password to secret
SETSUBMIT password
INPUTIS password
CONFIGIS html_password
MATCH Updated password to 

# TODO Check SMTP stealth (write when doing TestSMTP)
# TODO Check SMTP chain options (write when doing TestSMTP)
# TODO Check NNTP stealth (write when doing TestNNTP)
# TODO Check XMLRPC stealth (write when doing TestXMLRPC)

# Advanced Page

GET /advanced

# Check presence of ignore words

MATCH one
MATCH two
MATCH three

# Check add ignore word

CONFIGIS newword
SETSUBMIT newword four11@.-_
MATCH four11@.-_
SETSUBMIT newword ba"d
MATCH Ignored words can only contain alphanumeric, ., _, -, or @ characters

# Check remove ignore word

CONFIGIS word
SETSUBMIT word four11@.-_
NOTMATCH four11@.-_

# Check change arbitrary parameter

SETSUBMIT parameter_bayes_hostname testhostname
CONFIGIS bayes_hostname testhostname
INPUTIS parameter_bayes_hostname testhostname

# TODO Check shutdown operation
# TODO Check bad session key